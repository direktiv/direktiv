version: "3.9"
services:
  fluent-bit:
    image: fluent/fluent-bit:1.9.9
    hostname: fluent-bit
    environment:
      PG_HOST: postgres
      PG_PORT: 5432
      PG_USER: fluentbit
      PG_PASSWORD: mypassword
      PG_DATABASE: mydb
    ports:
      - "24224:24224"
      - "24224:24224/udp"
    volumes:
      - ./fluent-bit.conf:/fluent-bit/etc/fluent-bit.conf
    depends_on:
      - postgres
    command: [fluent-bit", "-c", "/fluent-bit/etc/fluent-bit.conf"]
  postgres:
    image: postgres:buster
    hostname: postgres
    environment:
      POSTGRES_USER: myadmin
      POSTGRES_PASSWORD: mypassword
      POSTGRES_DB: mydb
      PG_USER: fluentbit
      PG_PASSWORD: mypassword
      POSTGRES_INITDB_ARGS: "-A password"
    ports:
      - "5432:5432"
    volumes:
      - ./pgdata:/var/lib/postgresql/data
    depends_on:
      - postgres-init
  postgres-init:
    image: postgres:buster
    hostname: postgres
    environment:
      POSTGRES_USER: myadmin
      POSTGRES_PASSWORD: mypassword
      POSTGRES_DB: mydb
      PG_USER: fluentbit
      PG_PASSWORD: mypassword
      POSTGRES_INITDB_ARGS: "-A password"
    command: ["-c", "exit 0"]
    ports:
      - "5433:5432"
    volumes:
      - ./init-db.sh:/docker-entrypoint-initdb.d/init-db.sh
      - ./pgdata:/var/lib/postgresql/data
  flow:
    image: ${DIREKTIV_IMAGE}
    command: ["/bin/direktiv", "server"]
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - DIREKTIV_APP=flow

      - DIREKTIV_API_V1_PORT=8181
      - DIREKTIV_GRPC_PORT=6666
      - DIREKTIV_API_V2_PORT=6667
      - DIREKTIV_DEBUG=true

      - DIREKTIV_DB=host=postgres port=5432 user=myadmin dbname=mydb password=mypassword sslmode=disable
      - DIREKTIV_SECRET_KEY=01234567890123456789012345678912
      - DIREKITV_ENABLE_DOCKER=true

      - DIREKTIV_KNATIVE_NAMESPACE=direktiv-services-direktiv
      - DIREKTIV_FUNCTIONS_TIMEOUT=7200
      - DIREKTIV_LOG_JSON=console

    ports:
      - "8181:8181"
      - "6666:6666"
      - "6667:6667"
    depends_on:
      - postgres
      - fluent-bit
    logging:
      driver: fluentd
      options:
        tag: flow
        fluentd-address: localhost:24224

  ui:
    image: ${DIREKTIV_UI_IMAGE}
    environment:
      - UI_BACKEND=http://flow:8181/api/
      - UI_PORT=8080
    ports:
      - "8080:8080"
    depends_on:
      - postgres
      - flow

  e2e-tests:
    image: node:lts-alpine3.18
    volumes:
      - ./tests:/tests
    environment:
      - NODE_TLS_REJECT_UNAUTHORIZED=0
      - DIREKTIV_HOST=http://flow:8181
    command: npm --prefix /tests run without-k8s
    depends_on:
      - flow