version: "3.9"
services:
  postgres:
    image: postgres:15
    command: [
        "postgres",
        ## "-c", "log_statement=all",
        ## "-c", "log_destination=stderr",
      ]
    environment:
      POSTGRES_USER: myadmin
      POSTGRES_PASSWORD: mypassword
      POSTGRES_DB: mydb
      POSTGRES_INITDB_ARGS: "-A password"
    ports:
      - "5432:5432"
    volumes: []

  flow:
    image: direktiv-dev
    command: ["/app/direktiv", "start", "api"]
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - DIREKTIV_API_PORT=8080
      - DIREKTIV_DEBUG=true

      - DIREKTIV_DB=host=postgres port=5432 user=myadmin dbname=mydb password=mypassword sslmode=disable
      - DIREKTIV_SECRET_KEY=01234567890123456789012345678912
      - DIREKTIV_DISABLE_SERVICES=true

      - DIREKTIV_KNATIVE_NAMESPACE=direktiv-services-direktiv
      - DIREKTIV_FUNCTIONS_TIMEOUT=7200
      - DIREKTIV_LOG_JSON=console

    ports:
      # api port
      - "8080:8080"
    depends_on:
      - postgres

  e2e-api:
    image: node:lts-alpine3.18
    volumes:
      - ./tests:/tests
    environment:
      - NODE_TLS_REJECT_UNAUTHORIZED=0
      - DIREKTIV_HOST=http://flow:8080
    command: npm --prefix /tests run jest -- ${JEST_PREFIX} --runInBand
    depends_on:
      - flow
